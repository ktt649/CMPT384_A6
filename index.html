<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Assignment 6</title>
		
		<script type="text/javascript" src="d3.v5.min.js"></script>
		<style type="text/css">


			svg {
				background-color: white;
			}

			h1 {
				color: rgb(115, 115, 115);
				font-size: 18px;
				font-family: sans-serif;
				font-weight: bold;
				margin: 0;
				padding-bottom: 10px;

			}

				#container {
				width: 800px;
				margin-left: auto;
				margin-right: auto;
				margin-top: 20px;
				padding: 20px;
				background-color: white;
				box-shadow: 1px 1px 1px 2px rgb(217, 217, 217);
			}
			
			/* style for slider */
	        .slidecontainer {
	            width: 100%;
	        }

	        .slider {
	            -webkit-appearance: none;
	            width: 100%;
	            height: 15px;
	            border-radius: 5px;
	            background: #d3d3d3;
	            outline: none;
	            opacity: 0.7;
	            -webkit-transition: .2s;
	            transition: opacity .2s;
	        }

	        .slider:hover {
	            opacity: 1;
	        }

	        .slider::-webkit-slider-thumb {
	            -webkit-appearance: none;
	            appearance: none;
	            width: 25px;
	            height: 25px;
	            border-radius: 50%;
	            background: #4CAF50;
	            cursor: pointer;
	        }

	        .slider::-moz-range-thumb {
	            width: 25px;
	            height: 25px;
	            border-radius: 50%;
	            background: #4CAF50;
	            cursor: pointer;
	        }
	        
	        .slider-heading {
	            font-family: sans-serif; 
	            margin-top:40px;
	        }

	        #checkboxes{
	        	width: 800px;
	        	padding: 5px;
    			margin: 0 auto;
    			text-align: center;
    			justify-content: space-between;
    			display: flex;
	        }

	        input{
	        	padding:10px;
	        }

	        .checkDiv{
	        	display:inline;
	        }

	        #filterHead{
	        	margin: 3px;
	        }

	        #filterDiv{
	        	width: 800px;
    			margin: 0 auto;
	        }

		</style>
	</head>
	<body>


	<div id="container">
		<h1>WWI Bombing Operations</h1>

	</div>
		<script type="text/javascript">



			//Datastructures
			var w = 800;
			var h = 600;
			d3.csv("BombingData.csv").then(function(d){
				bombData = d;
			});
			var mapData;
			var countrySet = new Set();
			var countryList = new Array();
			var nodes;
			var map;

			//Define map projection
			var projection = d3.geoMercator()
									.translate([ w/2, h/2 ])
								    .scale([w/1]) 
								    .center([ 12, 51 ]);
								   

			//Define path generator
			var path = d3.geoPath()
							 .projection(projection);


			var attachZoom = d3.zoom().on('zoom', function(d) {
        		d3.select('g').attr('transform', d3.event.transform);
    		})

			//Create SVG
			var svg = d3.select("#container")
						.append("svg")
						.attr("width", w)
						.attr("height", h)
						.call(attachZoom);

			var innerGraphicContainer = svg.append('g');
			drawMap(innerGraphicContainer);

			function drawMap(g){
				//Load in GeoJSON data
				map = d3.json("med.custom.geo.json").then(function(json) {
					
					mapData = json
					//Bind data and create one path per GeoJSON feature
					g.selectAll("path")
					   .data(json.features)
					   .enter()
					   .append("path")
					   .attr("d", path)
					   .attr("stroke", "rgba(8, 81, 156, 0.2)")
					   .attr("fill", "rgba(8, 81, 156, 0.6)")
					   .on('click', function(d){
		                	console.log("TARGET: " + d.TGTCOUNTRY);
		                	console.log("COUNTRY: " + d.COUNTRY);
		                })
					    //INTERACT WITH MAP
		                .on('mouseover', function(d){
		                	d3.select(this).style("cursor", "pointer"); 
		                	//d3.select(this).style("fill", "rgba(8, 81, 156, 0.2)");
		                })
		                .on('mouseout', function(d){
		                	d3.select(this).style("fill", "rgba(8, 81, 156, 0.6)");
		                })
				        .append('title')
		                    .text(function(d) {
		                        return d.properties.name;
		                });

		            //Plot Points
		            plotPoints(g);
		            //Create Checkboxes for filtering
					createCheckboxes(bombData);
					d3.selectAll(".checkbox").on("change", update);
				});
				
			}
			
			function plotPoints(g){
				//Load in the Bomb run data
				nodes = d3.csv("BombingData.csv").then(function (data){	
					
					
					// Display Circle
			        var circles = g.selectAll("circle")
				        .data(data)

				    // EXIT - Circles that are no longer in the dataset
			        circles
			            .exit()
			            .attr('r', 0)
			            .remove();

				    circles.enter()
				        .append("circle")
				        .attr("cx", function(d) {
				            return projection([d.LONGITUDE, d.LATITUDE])[0];
				        })
				        .attr("cy", function(d) {
				            return projection([d.LONGITUDE, d.LATITUDE])[1];
				        })
				        .attr("r", function(d){
				        	return 2;  	
				        })
				        .style("fill", "Black")

				        //INTERACT WITH DATAPOINTS
		                .on('click', function(d){
		                	console.log("TARGET: " + d.TGTCOUNTRY);
		                	console.log("COUNTRY: " + d.COUNTRY);
		                })
		                .on('mouseover', function(d){
		                	d3.select(this).style("fill", "Red");
		                })
		                .on('mouseout', function(d){
		                	d3.select(this).style("fill", "Black");
		                })
				        .append('title').text(function(d) {
		                    	if(d.WEAPONWEIGHT == 0){
		                    		return d.COUNTRY + " dropped an unknown payload, targeting " + d.TGTCOUNTRY;
		                    	}else{
		                    		return d.COUNTRY + " dropped " + d.WEAPONWEIGHT + " LBS, targeting " + d.TGTCOUNTRY;
		                    	}
		                        
		                });		
				});
			}
			

			function createCheckboxes(bombData){
				//Get array of countries for checkboxes
				for(var i = 0; i < bombData.length; i++){
					var c = bombData[i].COUNTRY
					if(! c == ""){
						countrySet.add(c);
					}
				}

				countrySet.forEach(v => countryList.push(v));

				var myDiv = document.getElementById("checkboxes");
				var headDiv = document.getElementById("filterHead");
				var filter = document.createElement("h3");
				headDiv.appendChild(filter);

				filter.id = "filterHead";
				filter.appendChild(document.createTextNode("Filter by country:"));


				for (var i = 0; i < countryList.length; i++) {
					var country = String(countryList[i]);

				    var checkBox = document.createElement("input");
				    checkBox.type = "checkbox";
				    checkBox.value = countryList[i];
				    checkBox.id = countryList[i] + "_Box";
				    checkBox.className = "checkbox";
				    checkBox.checked = true;

				    var checkDiv = document.createElement("div");
				    checkDiv.className = "checkDiv";
				    checkDiv.appendChild(checkBox);

				    var label = document.createElement("label");
				    checkDiv.appendChild(label);
				    myDiv.appendChild(checkDiv);
				    label.appendChild(document.createTextNode(countryList[i]));    
				}
			}

			function update(bombData){
		        var choices = [];
		        d3.selectAll(".checkbox").each(function(d){
		          
		          if(d.checked){
		            choices.push(d.value);
		          }
		        });
		      
		        if(choices.length > 0){
		          newData = [];
		          for(var i = 0; i < bombData.length; i++){
		          	if(choices.includes(bombData[i].COUNTRY)){
		          		newData.push(bombData[i]);
		          	}
		          }
		        } else {
		          newData = bombData;     
		        } 
		       	plotPoints(newData); 
      		}
		
		</script>
    </div>
    <div id = 'filterDiv'>
    	<div id = 'filterHead'></div>
    	<div id = 'checkboxes'></div>
    </div>
	</body>
</html>